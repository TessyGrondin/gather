<!DOCTYPE html>
<html>
<head>
  <title>Gather</title>
  <meta charset="UTF-8">
  <style>
  html, body {
    height: 100%;
    margin: 0;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  canvas {
    border: 1px solid black;
  }
  </style>
</head>
<body>
<canvas width="320" height="480" id="game"></canvas>
<script>
const canvas = document.getElementById('game');
const context = canvas.getContext('2d');

let end = false;
let menu = false;

let score = 0;

context.font = "30px Arial";
context.textAlign = "center";
context.fillStyle = 'yellow';

let tiles = [0,0,0,0,1,1,1,1,1,1,
             0,0,0,0,1,1,1,1,1,1,
             0,0,0,0,1,1,1,1,1,1,
             0,0,0,0,1,1,1,1,1,1,
             1,1,1,1,1,1,1,1,1,1,
             1,1,1,1,1,1,1,1,1,1,
             1,1,1,1,1,1,1,1,1,1,
             1,1,1,1,1,1,1,1,1,1,
             1,1,1,1,1,1,1,1,1,1,
             1,1,1,1,1,1,1,1,1,1,
             1,1,1,1,1,1,1,0,0,0,
             1,1,1,1,1,1,1,0,0,0,
             0,0,0,1,1,1,1,0,0,0,
             0,0,0,1,1,1,1,0,0,0,
             0,0,0,1,1,1,1,0,0,0];
let currentFrame = 0;

let borderA = 96;
let borderB = 64;
let obstacles = [{relX:3, relY:0, type:1, reversed:false},
                 {relX:2, relY:3, type:2, reversed:false},
                 {relX:6, relY:4, type:2, reversed:false},
                 {relX:3, relY:6, type:1, reversed:true},
                 {relX:7, relY:9, type:2, reversed:false},
                 {relX:0, relY:11, type:2, reversed:false},
                 {relX:6, relY:13, type:1, reversed:true},
                 {relX:2, relY:14, type:1, reversed:false}];

let surroundings = new Image();
surroundings.src = "surroundings.png"

let crocImage = new Image();
crocImage.src = "croc.png"

const left = 0;
const right = 1;
const up = 2;
const down = 3;

let crocs = [{x:4, y:8, orientation:left}, {x:4, y:8, orientation:right}];

function drawCrocs() {
  crocs.forEach(function(croc) {
    if (croc.orientation == left)
      context.drawImage(crocImage, 0, 0, 316 / 4, 37, croc.x * 32, croc.y * 32, 316 / 4, 37);
    else if(croc.orientation == right) {
      context.save();
      context.translate(canvas.width, canvas.height);
      context.rotate(-Math.PI);
      context.drawImage(crocImage, 0, 0, 316 / 4, 37, croc.x * 32 - canvas.width + (316 / 4) * 1.5, croc.y * 32 + canvas.height - 37, 316 / 4, 37);
      context.restore();
    }
  });
}

function loop() {
  requestAnimationFrame(loop);
  context.clearRect(0,0,canvas.width,canvas.height);

  for (let i = 0; i < tiles.length; i++)
    context.drawImage(surroundings, 160 + currentFrame * 32, tiles[i] * 32, 32, 32, (i % 10) * 32, (Math.floor(i / 10)) * 32, 32, 32);
  for (let i = 0; i < obstacles.length; i++) {
    if (obstacles[i].type == 1) {
      if (obstacles[i].reversed) {
        context.save();
        context.scale(-1, 1);
        context.drawImage(surroundings, 0, 0, borderB, borderA, -((obstacles[i].relX) * 32) - 64, (Math.floor(obstacles[i].relY)) * 32, borderB, borderA);
        context.restore();
      } else {
        context.drawImage(surroundings, 0, 0, borderB, borderA, (obstacles[i].relX) * 32, (Math.floor(obstacles[i].relY)) * 32, borderB, borderA);
      }
    } else {
      context.drawImage(surroundings, 64, 0, borderA, borderB, (obstacles[i].relX) * 32, (Math.floor(obstacles[i].relY)) * 32, borderA, borderB);
    }
  }
  if (menu) {
    context.font = "50px Arial";
    context.fillText("tap to start", canvas.width / 2, canvas.height / 2);
  } else if (!end) {
    drawCrocs();
  //   enemies.forEach(function(enemy) {
  //     context.drawImage(enemyImage, enemy.state * 32, 0, 32, 16, enemy.x, enemy.y, 32, 16);
  //     if (collide(enemy))
  //       end = true;
  //   });
  //   if (spawnTime >= enemySpawnRate) {
  //     spawnTime = 0;
  //     if (enemySpawnRate > 100)
  //       enemySpawnRate -= 10;
  //     let x = xpos[Math.floor(Math.random() * 5)];
  //     let y = ypos[Math.floor(Math.random() * 2)];
  //     let angle = Math.atan2((350 + 64) - y, (130 + 64) - x);
  //     let dirx = Math.cos(angle);
  //     let diry = Math.sin(angle);
  //     enemies.push({x:x, y:y, angle:angle, dirx:dirx, diry:diry, state:0});
  //   }
  //   enemies = enemies.filter(function(enemy) {
  //     return onScreen(enemy);
  //   })
  } else {
    context.font = "50px Arial";
    context.fillText("your score : " + score, canvas.width / 2, canvas.height / 2);
    context.font = "20px Arial";
    context.fillText("tap to restart", canvas.width / 2, canvas.height - 10);
  }
}

function animateWater() {
  currentFrame += 1;
  if (currentFrame >= 3)
    currentFrame = 0;
  canvas.clearRect(0, 0, canvas.width, canvas.height);
}

// function enemyMove() {
//   if (!end && !menu) {
//     enemies.forEach(function(enemy) {
//       enemy.y += enemy.diry;
//       enemy.x += enemy.dirx;
//     });
//   }
// }

// function collide(enemy) {
//   if (!end && enemy.state == 0 && !menu) {
//     if (enemy.y > 475 || 400 > enemy.y + 16)
//       return false;
//     if (enemy.x > 245 || 145 > enemy.x + 32)
//       return false;
//     return true;
//   }
//   return false;
// }

// function onScreen(enemy) {
//   if (!end && !menu) {
//     if (enemy.y > canvas.height || enemy.y + 16 < 0)
//       return false;
//     if (enemy.x > canvas.width || enemy.x + 32 < 0)
//       return false;
//     return true;
//   }
//   return false;
// }

setInterval(animateWater, 120);
// setInterval(backgroundMove, 10);
// setInterval(enemyMove, 20);
// setInterval(incrementSpawnTime, 1);

document.addEventListener('mousedown', function(e) {
  let relativeX = e.x - canvas.offsetLeft;
  let relativeY = e.y - canvas.offsetTop;

  if (menu) {
    menu = false;
    return;
  }
  if (!end) {
  //   enemies.forEach(function(enemy) {
  //     if (relativeY < enemy.y || relativeY > enemy.y + 16)
  //       return;
  //     if (relativeX < enemy.x || relativeX > enemy.x + 32)
  //       return;
  //     enemy.state = 1;
  //     enemy.dirx = - enemy.dirx;
  //     enemy.diry = - enemy.diry;
  //     score += 1;
  //   });
  } else {
    score = 0;
    end = false;
  }
});
// context.save();
// context.translate(canvas.width / 2, canvas.height / 2);
// context.rotate(Math.PI / 2);//x = 2, y = 2
// context.fillRect(1, -7, 6, 4);//90° clockwise, (x - 1, -height - y - 1)
// context.restore();
// context.save();
// context.translate(canvas.width / 2, canvas.height / 2);
// context.rotate(-Math.PI / 2);
// context.fillRect(-4 - 3, 3, 6, 4);//90° not clockwise, (-height -y + 1, x + 1)
// context.restore();
// context.save();
// context.translate(canvas.width / 2, canvas.height / 2);
// context.rotate(-Math.PI);
// context.fillRect(-8, -6, 6, 4);//180°, (-width - x, -height - y)
// context.restore();
requestAnimationFrame(loop);
</script>
</body>
</html>